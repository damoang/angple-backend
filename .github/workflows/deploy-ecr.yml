name: Deploy ECR to Prod

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      confirm:
        description: '배포 확인 ("deploy" 입력)'
        required: true
        type: string
      target:
        description: '배포 대상'
        required: true
        default: 'api'
        type: choice
        options:
          - api
          - gateway
          - all
      image_tag:
        description: '배포할 이미지 태그 (비워두면 latest)'
        required: false
        type: string

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: angple-backend
  ECR_REGISTRY: 891376997084.dkr.ecr.ap-northeast-2.amazonaws.com

jobs:
  build:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::891376997084:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployments/docker/api.Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:sha-${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha,scope=backend-api
          cache-to: type=gha,mode=max,scope=backend-api

  deploy:
    name: Deploy to K8s
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.confirm == 'deploy'

    steps:
      - name: Set image tag
        id: tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "TAG=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=latest" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::891376997084:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API via SSM
        if: inputs.target == 'api' || inputs.target == 'all'
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.TAG }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-038a1d1f00798d94b" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "kubectl set image deployment/angple-backend -n angple backend='"${{ env.ECR_REGISTRY }}"'/'"${{ env.ECR_REPOSITORY }}"':'"$IMAGE_TAG"'",
              "kubectl rollout status deployment/angple-backend -n angple --timeout=120s"
            ]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          echo "Waiting for deployment..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" || true

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "Status" \
            --output text)

          echo "Status: $STATUS"

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "StandardOutputContent" \
            --output text

          if [ "$STATUS" != "Success" ]; then
            echo "Error:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-038a1d1f00798d94b" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi

      - name: Deploy Gateway via SSM
        if: inputs.target == 'gateway' || inputs.target == 'all'
        env:
          IMAGE_TAG: gateway-${{ steps.tag.outputs.TAG }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-038a1d1f00798d94b" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "kubectl set image deployment/angple-gateway -n angple gateway='"${{ env.ECR_REGISTRY }}"'/'"${{ env.ECR_REPOSITORY }}"':'"$IMAGE_TAG"'",
              "kubectl rollout status deployment/angple-gateway -n angple --timeout=120s"
            ]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          echo "Waiting for deployment..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" || true

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "Status" \
            --output text)

          echo "Status: $STATUS"

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "StandardOutputContent" \
            --output text

          if [ "$STATUS" != "Success" ]; then
            echo "Error:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-038a1d1f00798d94b" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
