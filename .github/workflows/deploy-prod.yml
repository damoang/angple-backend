name: Deploy to Prod (EC2)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: commit SHA)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - run: go test -v ./...

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Set image tag
        id: set-tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          if [ -n "$INPUT_TAG" ]; then
            echo "tag=$INPUT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=main-$(echo "$COMMIT_SHA" | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::891376997084:role/GitHubActionsDeployRole
          aws-region: ap-northeast-2

      - name: Deploy via SSM
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-038a1d1f00798d94b" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "export HOME=/home/damoang",
              "export IMAGE_TAG='"$IMAGE_TAG"'",
              "export ECR_REGISTRY=891376997084.dkr.ecr.ap-northeast-2.amazonaws.com",
              "export REPOSITORY=damoang",
              "cd /home/damoang/angple-backend",
              "git config --global --add safe.directory /home/damoang/angple-backend",
              "git fetch origin",
              "git checkout main",
              "git reset --hard origin/main",
              "echo Deploying angple-backend with tag: $IMAGE_TAG",
              "aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $ECR_REGISTRY",
              "docker build -f deployments/docker/api.Dockerfile -t $ECR_REGISTRY/$REPOSITORY:api-$IMAGE_TAG -t $ECR_REGISTRY/$REPOSITORY:api-latest .",
              "docker build -f deployments/docker/gateway.Dockerfile -t $ECR_REGISTRY/$REPOSITORY:gateway-$IMAGE_TAG -t $ECR_REGISTRY/$REPOSITORY:gateway-latest .",
              "docker push $ECR_REGISTRY/$REPOSITORY:api-$IMAGE_TAG",
              "docker push $ECR_REGISTRY/$REPOSITORY:api-latest",
              "docker push $ECR_REGISTRY/$REPOSITORY:gateway-$IMAGE_TAG",
              "docker push $ECR_REGISTRY/$REPOSITORY:gateway-latest",
              "docker rm -f angple-api angple-gateway 2>/dev/null || true",
              "sleep 3",
              "source /home/damoang/angple-backend/.env 2>/dev/null || true",
              "docker network create angple-network 2>/dev/null || true",
              "docker run -d --name angple-api -p 8081:8081 --restart unless-stopped --network angple-network --memory=1g -e APP_ENV=${APP_ENV:-prod} -e DB_HOST=${DB_HOST:-host.docker.internal} -e DB_PORT=${DB_PORT:-3306} -e DB_USER=${DB_USER:-damoang} -e DB_PASSWORD=${DB_PASSWORD} -e DB_NAME=${DB_NAME:-damoang} -e REDIS_HOST=${REDIS_HOST:-host.docker.internal} -e REDIS_PORT=${REDIS_PORT:-6379} -e JWT_SECRET=${JWT_SECRET} -e DAMOANG_JWT_SECRET=${DAMOANG_JWT_SECRET} -e API_PORT=8081 -e RECOMMENDED_DATA_PATH=/data/recommended -e CORS_ALLOW_ORIGINS=https://damoang.dev,https://api.damoang.dev,https://web.damoang.net,https://damoang.net -v /home/damoang/www/data/cache/recommended:/data/recommended:ro --add-host=host.docker.internal:host-gateway $ECR_REGISTRY/$REPOSITORY:api-$IMAGE_TAG",
              "docker run -d --name angple-gateway -p 8080:8080 --restart unless-stopped --network angple-network --memory=512m -e LARAVEL_BACKEND_URL=http://host.docker.internal:80 -e GO_API_URL=http://angple-api:8081 -e GATEWAY_PORT=8080 --add-host=host.docker.internal:host-gateway $ECR_REGISTRY/$REPOSITORY:gateway-$IMAGE_TAG",
              "docker network connect proxy-network angple-api 2>/dev/null || true",
              "docker network connect proxy-network angple-gateway 2>/dev/null || true",
              "sleep 10",
              "docker ps | grep -E angple-",
              "docker image prune -f",
              "echo Deployed at $(date)"
            ]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          # 완료 대기
          echo "Waiting for command to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" || true

          # 결과 확인
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "Status" \
            --output text)

          echo "Command Status: $STATUS"

          # 출력 로그
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "StandardOutputContent" \
            --output text

          if [ "$STATUS" != "Success" ]; then
            echo "Error output:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-038a1d1f00798d94b" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
