name: Deploy Binary to Prod

on:
  workflow_dispatch:
    inputs:
      target:
        description: '배포 대상'
        required: true
        default: 'api'
        type: choice
        options:
          - api
          - gateway
          - all

permissions:
  id-token: write
  contents: write

env:
  GO_VERSION: '1.24'

jobs:
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: api
            path: cmd/api/main.go
            output: api
          - name: gateway
            path: cmd/gateway/main.go
            output: gateway

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build for Linux ARM64
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -o ${{ matrix.output }} ${{ matrix.path }}
          chmod +x ${{ matrix.output }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-binary
          path: ${{ matrix.output }}
          retention-days: 1

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download API binary
        if: inputs.target == 'api' || inputs.target == 'all'
        uses: actions/download-artifact@v4
        with:
          name: api-binary
          path: ./binaries

      - name: Download Gateway binary
        if: inputs.target == 'gateway' || inputs.target == 'all'
        uses: actions/download-artifact@v4
        with:
          name: gateway-binary
          path: ./binaries

      - name: Create GitHub Release
        id: release
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG="deploy-${TIMESTAMP}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT

          # Delete old deploy releases (keep last 5)
          gh release list --limit 100 | grep "^deploy-" | tail -n +6 | cut -f1 | while read tag; do
            gh release delete "$tag" --yes --cleanup-tag || true
          done

          # Create new release with binaries
          gh release create "${TAG}" \
            --title "Deploy ${TIMESTAMP}" \
            --notes "Automated deployment - ${{ inputs.target }}" \
            ./binaries/*

          echo "Release created: ${TAG}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::891376997084:role/GitHubActionsDeployRole
          aws-region: ap-northeast-2

      - name: Deploy via SSM
        env:
          TARGET: ${{ inputs.target }}
          RELEASE_TAG: ${{ steps.release.outputs.TAG }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-038a1d1f00798d94b" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/angple/backend",

              "# Download as angple user (has gh auth)",
              "if [ \"'"$TARGET"'\" = \"api\" ] || [ \"'"$TARGET"'\" = \"all\" ]; then",
              "  echo Downloading API binary...",
              "  sudo -u angple gh release download '"$RELEASE_TAG"' --repo damoang/angple-backend --pattern api -D /tmp --clobber",
              "  mv /tmp/api ./bin/api-new",
              "  chmod +x ./bin/api-new",
              "fi",

              "if [ \"'"$TARGET"'\" = \"gateway\" ] || [ \"'"$TARGET"'\" = \"all\" ]; then",
              "  echo Downloading Gateway binary...",
              "  sudo -u angple gh release download '"$RELEASE_TAG"' --repo damoang/angple-backend --pattern gateway -D /tmp --clobber",
              "  mv /tmp/gateway ./bin/gateway-new",
              "  chmod +x ./bin/gateway-new",
              "fi",

              "# Deploy API (as root)",
              "if [ \"'"$TARGET"'\" = \"api\" ] || [ \"'"$TARGET"'\" = \"all\" ]; then",
              "  echo Deploying API...",
              "  pkill -f ./bin/api || true",
              "  sleep 2",
              "  mv ./bin/api-new ./bin/api",
              "  source .env 2>/dev/null || true",
              "  nohup ./bin/api > /home/angple/api.log 2>&1 &",
              "  sleep 3",
              "  pgrep -f ./bin/api && echo API started successfully || echo API failed to start",
              "fi",

              "# Deploy Gateway (as root)",
              "if [ \"'"$TARGET"'\" = \"gateway\" ] || [ \"'"$TARGET"'\" = \"all\" ]; then",
              "  echo Deploying Gateway...",
              "  pkill -f ./bin/gateway || true",
              "  sleep 2",
              "  mv ./bin/gateway-new ./bin/gateway",
              "  nohup ./bin/gateway > /home/angple/gateway.log 2>&1 &",
              "  sleep 3",
              "  pgrep -f ./bin/gateway && echo Gateway started successfully || echo Gateway failed to start",
              "fi",

              "echo Deployed at $(date)"
            ]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          echo "Waiting for deployment..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" || true

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "Status" \
            --output text)

          echo "Status: $STATUS"

          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "i-038a1d1f00798d94b" \
            --query "StandardOutputContent" \
            --output text

          if [ "$STATUS" != "Success" ]; then
            echo "Error:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "i-038a1d1f00798d94b" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
